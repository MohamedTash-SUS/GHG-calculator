<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV vs. Gasoline: Total Cost of Ownership Comparator</title>
    <style>
        :root {
            --primary: #2563eb;
            --ev-color: #10b981;
            --ev-color-light: #d1fae5;
            --ice-color: #f97316;
            --ice-color-light: #ffedd5;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg-color); color: var(--text-main); line-height: 1.5; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media(min-width: 1024px) { .container { grid-template-columns: 350px 1fr; } }

        /* Header */
        header { grid-column: 1 / -1; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        h1 { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .subtitle { color: var(--text-muted); font-size: 0.9rem; }
        .controls { display: flex; gap: 10px; align-items: center; }
        
        /* Layout Components */
        .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; border: 1px solid var(--border); }
        .section-title { font-weight: 600; font-size: 1.1rem; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
        .section-title::after { content: '▼'; font-size: 0.8em; margin-left: auto; color: var(--text-muted); transition: transform 0.2s; }
        .collapsed .section-title::after { transform: rotate(-90deg); }
        .section-content { display: block; }
        .collapsed .section-content { display: none; }

        /* Inputs */
        .input-group { margin-bottom: 15px; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; }
        label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-muted); margin-bottom: 4px; }
        input, select { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.95rem; transition: border 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--primary); }
        .ev-input { border-left: 3px solid var(--ev-color); }
        .ice-input { border-left: 3px solid var(--ice-color); }
        
        /* Specific input styles */
        .unit-label { font-size: 0.8rem; color: var(--text-muted); margin-left: 4px; }

        /* Button */
        .btn-calc { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: background 0.2s; }
        .btn-calc:hover { background: #1d4ed8; }

        /* Results Area */
        .results-header { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .result-card { padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); text-align: center; }
        .result-card.ev { background: var(--ev-color-light); border-color: var(--ev-color); }
        .result-card.ice { background: var(--ice-color-light); border-color: var(--ice-color); }
        .result-card.winner { border: 2px solid var(--primary); position: relative; }
        .result-card.winner::before { content: '★ WINNER'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 2px 8px; font-size: 0.7rem; border-radius: 10px; }
        
        .big-number { font-size: 1.8rem; font-weight: 700; display: block; margin: 5px 0; }
        .diff-text { font-size: 0.85rem; font-weight: 600; }
        .text-ev { color: #059669; }
        .text-ice { color: #ea580c; }

        /* Charts */
        .chart-container { height: 300px; width: 100%; margin-bottom: 30px; position: relative; }
        svg { width: 100%; height: 100%; overflow: visible; }
        
        .chart-legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; font-size: 0.9rem; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

        /* Table */
        .table-wrapper { overflow-x: auto; margin-top: 20px; border-radius: var(--radius); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; text-align: right; }
        th, td { padding: 10px 15px; border-bottom: 1px solid var(--border); }
        th { background: #f1f5f9; text-align: right; font-weight: 600; color: var(--text-main); position: sticky; top: 0; }
        th:first-child, td:first-child { text-align: left; }
        tr:last-child td { border-bottom: none; }

        /* Tooltips for charts */
        .tooltip { position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 10; white-space: nowrap; }

        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

    </style>
</head>
<body>

    <header>
        <div>
            <h1>EV vs. Gasoline TCO Calculator</h1>
            <div class="subtitle">Total Cost of Ownership & Emissions Comparator</div>
        </div>
        <div class="controls">
            <div class="toggle-container">
                <span>US (Mi/Gal)</span>
                <label class="switch">
                    <input type="checkbox" id="unitToggle">
                    <span class="slider"></span>
                </label>
                <span>Metric (Km/L)</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Input Section -->
        <aside>
            <div class="card">
                <div class="input-group">
                    <label>Preset Comparisons</label>
                    <select id="presetSelect">
                        <option value="custom">Custom</option>
                        <option value="sedan" selected>Sedan: Model 3 vs Camry</option>
                        <option value="suv">Crossover: Model Y vs RAV4</option>
                        <option value="truck">Truck: F-150 Lightning vs F-150</option>
                        <option value="compact">Compact: Leaf vs Civic</option>
                    </select>
                </div>

                <!-- Section 1: Vehicle & Basics -->
                <div class="input-section">
                    <div class="section-title" onclick="toggleSection(this)">Vehicle Details & Purchase</div>
                    <div class="section-content">
                        <div class="input-row">
                            <div>
                                <label style="color:var(--ev-color)">EV Price</label>
                                <input type="number" id="priceEV" class="ev-input" value="40000">
                            </div>
                            <div>
                                <label style="color:var(--ice-color)">Gas Price</label>
                                <input type="number" id="priceICE" class="ice-input" value="30000">
                            </div>
                        </div>
                        <div class="input-row">
                            <div>
                                <label>Incentives (EV)</label>
                                <input type="number" id="incentiveEV" class="ev-input" value="7500">
                            </div>
                            <div>
                                <label>Rebates (Gas)</label>
                                <input type="number" id="incentiveICE" class="ice-input" value="0">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Home Charger & Install (EV only)</label>
                            <input type="number" id="chargerCost" class="ev-input" value="1200">
                        </div>
                        <div class="input-group">
                            <label>Ownership Period (Years)</label>
                            <input type="number" id="years" value="8" min="1" max="20">
                        </div>
                        <div class="input-group">
                            <label>Annual Distance (<span class="unit-dist">mi</span>)</label>
                            <input type="number" id="distance" value="13500">
                        </div>
                    </div>
                </div>

                <!-- Section 2: Energy & Efficiency -->
                <div class="input-section">
                    <div class="section-title" onclick="toggleSection(this)">Efficiency & Energy Costs</div>
                    <div class="section-content">
                        <div class="input-row">
                            <div>
                                <label>EV Eff. (<span class="unit-eff-ev">kWh/100mi</span>)</label>
                                <input type="number" id="effEV" class="ev-input" value="25" step="0.1">
                            </div>
                            <div>
                                <label>Gas Eff. (<span class="unit-eff-ice">MPG</span>)</label>
                                <input type="number" id="effICE" class="ice-input" value="32" step="0.1">
                            </div>
                        </div>
                        <div class="input-row">
                            <div>
                                <label>Elec. Cost (<span class="currency">$</span>/kWh)</label>
                                <input type="number" id="costElec" class="ev-input" value="0.16" step="0.01">
                            </div>
                            <div>
                                <label>Fuel Cost (<span class="currency">$</span>/<span class="unit-vol">gal</span>)</label>
                                <input type="number" id="costFuel" class="ice-input" value="3.50" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Maintenance & Resale -->
                <div class="input-section">
                    <div class="section-title collapsed" onclick="toggleSection(this)">Maintenance, Resale & Financials</div>
                    <div class="section-content">
                        <div class="input-row">
                            <div>
                                <label>Maint/Yr (EV)</label>
                                <input type="number" id="maintEV" class="ev-input" value="600">
                            </div>
                            <div>
                                <label>Maint/Yr (Gas)</label>
                                <input type="number" id="maintICE" class="ice-input" value="900">
                            </div>
                        </div>
                        <div class="input-row">
                            <div>
                                <label>Insur/Yr (EV)</label>
                                <input type="number" id="insurEV" class="ev-input" value="1200">
                            </div>
                            <div>
                                <label>Insur/Yr (Gas)</label>
                                <input type="number" id="insurICE" class="ice-input" value="1000">
                            </div>
                        </div>
                        <div class="input-group">
                             <label>Resale Value after period (%)</label>
                             <div class="input-row">
                                <input type="number" id="resalePctEV" class="ev-input" value="40" placeholder="EV %">
                                <input type="number" id="resalePctICE" class="ice-input" value="35" placeholder="Gas %">
                             </div>
                        </div>
                        <div class="input-row">
                            <div>
                                <label>Discount Rate (%)</label>
                                <input type="number" id="discountRate" value="0" step="0.1" title="For NPV Calculation">
                            </div>
                            <div>
                                <label>Inflation (%)</label>
                                <input type="number" id="inflationRate" value="2" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Emissions -->
                <div class="input-section">
                    <div class="section-title collapsed" onclick="toggleSection(this)">Environmental Inputs</div>
                    <div class="section-content">
                         <div class="input-group">
                            <label>Grid Intensity (gCO₂/kWh)</label>
                            <select id="gridIntensity">
                                <option value="367">US Average (367g)</option>
                                <option value="250">California/Green Grid (250g)</option>
                                <option value="500">Coal Heavy (500g)</option>
                                <option value="250">EU Average (250g)</option>
                                <option value="0">100% Renewable (0g)</option>
                                <option value="custom">Custom</option>
                            </select>
                            <input type="number" id="gridCustom" value="367" style="margin-top:5px; display:none;">
                         </div>
                         <div class="input-group">
                             <label class="switch" style="width: 30px; height: 16px; vertical-align: middle; margin-right: 5px;">
                                <input type="checkbox" id="lifecycleToggle" checked>
                                <span class="slider"></span>
                            </label>
                            <span style="font-size: 0.9rem;">Include Manufacturing Emissions (Lifecycle)</span>
                         </div>
                    </div>
                </div>

                <button class="btn-calc" onclick="calculate()">Update Comparison</button>
            </div>
        </aside>

        <!-- Results Section -->
        <main>
            <div class="results-header">
                <div class="result-card ev" id="cardEV">
                    <h3>Electric Vehicle</h3>
                    <span class="big-number" id="resTcoEV">$0</span>
                    <div class="diff-text">Cost per <span class="unit-dist-short">mi</span>: <span id="cpmEV">$0.00</span></div>
                </div>
                
                <div class="result-card ice" id="cardICE">
                    <h3>Gasoline Vehicle</h3>
                    <span class="big-number" id="resTcoICE">$0</span>
                    <div class="diff-text">Cost per <span class="unit-dist-short">mi</span>: <span id="cpmICE">$0.00</span></div>
                </div>

                <div class="result-card" id="cardSavings">
                    <h3>Total Savings</h3>
                    <span class="big-number" id="resSavings" style="color:var(--primary)">$0</span>
                    <div class="diff-text" id="paybackText">Breakeven: Year 3</div>
                </div>
            </div>

            <div class="card">
                <h3>Cumulative Cost Over Time</h3>
                <div class="chart-legend">
                    <div class="legend-item"><div class="dot" style="background:var(--ev-color)"></div> EV</div>
                    <div class="legend-item"><div class="dot" style="background:var(--ice-color)"></div> Gasoline</div>
                </div>
                <div class="chart-container" id="lineChartContainer">
                    <!-- SVG injected by JS -->
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); text-align: center;">*Includes purchase price, operating costs, and resale value deduction at end of period.</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div class="card">
                    <h3>Cost Breakdown (Total)</h3>
                    <div class="chart-container" id="barChartContainer">
                        <!-- SVG injected by JS -->
                    </div>
                </div>

                <div class="card">
                    <h3>CO₂ Emissions</h3>
                    <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--ev-color);" id="co2EV">0t</div>
                            <div style="font-size: 0.8rem;">EV Total</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--ice-color);" id="co2ICE">0t</div>
                            <div style="font-size: 0.8rem;">Gasoline Total</div>
                        </div>
                    </div>
                    <div class="chart-container" id="emissionsChartContainer" style="height: 180px;">
                         <!-- SVG injected by JS -->
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <div class="section-title collapsed" onclick="toggleSection(this)">Year-by-Year Data Table</div>
                <div class="section-content" style="display:none">
                    <div class="table-wrapper">
                        <table id="yearTable">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>EV Annual</th>
                                    <th>EV Cumulative</th>
                                    <th>Gas Annual</th>
                                    <th>Gas Cumulative</th>
                                    <th>Savings</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Tooltip Element -->
    <div id="tooltip" class="tooltip"></div>

<script>
    /** * Constants & Configuration
     */
    const CONFIG = {
        metric: false, // false = US (Miles, MPG, Gallons), true = Metric (Km, kWh/100km, Liters)
        currency: '$'
    };

    // Constants for Emissions
    const EMISSIONS = {
        gasoline_g_per_gal: 8887, // gCO2 per gallon
        gasoline_g_per_liter: 2348, // gCO2 per liter
        ev_manufacturing_penalty_tons: 6, // Base tons CO2 penalty for battery manufacturing
        ice_manufacturing_tons: 7 // Base tons for ICE vehicle body (subtracted from EV penalty to get net difference or added to both)
        // Simply: EV starts with ~13t, ICE with ~7t. Net EV penalty ~6t.
    };

    // Preset Data
    const PRESETS = {
        sedan: {
            name: "Model 3 vs Camry",
            evPrice: 40000, icePrice: 28000,
            evInc: 7500, iceInc: 0,
            evEff: 25, iceEff: 32, // kWh/100mi, MPG
            evEffMetric: 15.6, iceEffMetric: 7.3, // kWh/100km, L/100km
            maintEV: 400, maintICE: 700,
            resaleEV: 45, resaleICE: 40
        },
        suv: {
            name: "Model Y vs RAV4",
            evPrice: 45000, icePrice: 32000,
            evInc: 7500, iceInc: 0,
            evEff: 28, iceEff: 29,
            evEffMetric: 17.4, iceEffMetric: 8.1,
            maintEV: 450, maintICE: 750,
            resaleEV: 48, resaleICE: 45
        },
        truck: {
            name: "F-150 Lightning vs F-150",
            evPrice: 60000, icePrice: 55000,
            evInc: 7500, iceInc: 0,
            evEff: 45, iceEff: 20,
            evEffMetric: 28, iceEffMetric: 11.7,
            maintEV: 600, maintICE: 900,
            resaleEV: 50, resaleICE: 50
        },
        compact: {
            name: "Leaf vs Civic",
            evPrice: 29000, icePrice: 26000,
            evInc: 3750, iceInc: 0,
            evEff: 30, iceEff: 35,
            evEffMetric: 18.6, iceEffMetric: 6.7,
            maintEV: 350, maintICE: 600,
            resaleEV: 35, resaleICE: 40
        }
    };

    /**
     * UI Logic
     */
    function toggleSection(element) {
        element.classList.toggle('collapsed');
        // If expanding, display block
        const content = element.nextElementSibling;
        if (!element.classList.contains('collapsed')) {
            content.style.display = 'block';
        } else {
            content.style.display = 'none';
        }
    }

    // Grid Intensity Custom Handler
    document.getElementById('gridIntensity').addEventListener('change', function(e) {
        const customInput = document.getElementById('gridCustom');
        if (e.target.value === 'custom') {
            customInput.style.display = 'block';
        } else {
            customInput.style.display = 'none';
            customInput.value = e.target.value;
        }
    });

    // Preset Loader
    document.getElementById('presetSelect').addEventListener('change', function(e) {
        if(e.target.value === 'custom') return;
        const p = PRESETS[e.target.value];
        if(!p) return;

        setVal('priceEV', p.evPrice);
        setVal('priceICE', p.icePrice);
        setVal('incentiveEV', p.evInc);
        setVal('incentiveICE', p.iceInc);
        setVal('maintEV', p.maintEV);
        setVal('maintICE', p.maintICE);
        setVal('resalePctEV', p.resaleEV);
        setVal('resalePctICE', p.resaleICE);

        // Efficiency depends on unit system
        if (CONFIG.metric) {
            setVal('effEV', p.evEffMetric);
            setVal('effICE', p.iceEffMetric);
        } else {
            setVal('effEV', p.evEff);
            setVal('effICE', p.iceEff);
        }
        calculate();
    });

    // Unit Toggle
    document.getElementById('unitToggle').addEventListener('change', function(e) {
        CONFIG.metric = e.target.checked;
        updateLabels();
        // Convert current efficiency inputs approximately for convenience
        // Note: Simple approximate conversion logic
        let curEffEV = getVal('effEV');
        let curEffICE = getVal('effICE');
        let curDist = getVal('distance');
        let curFuelPrice = getVal('costFuel');

        if (CONFIG.metric) {
            // US to Metric
            // EV: kWh/100mi -> kWh/100km (x 0.621371)
            document.getElementById('effEV').value = (curEffEV * 0.6214).toFixed(1);
            // ICE: MPG -> L/100km (235.215 / MPG)
            document.getElementById('effICE').value = (235.215 / curEffICE).toFixed(1);
            // Dist: Miles -> Km
            document.getElementById('distance').value = (curDist * 1.609).toFixed(0);
            // Fuel: $/Gal -> $/Liter
            document.getElementById('costFuel').value = (curFuelPrice / 3.785).toFixed(2);
        } else {
            // Metric to US
            document.getElementById('effEV').value = (curEffEV / 0.6214).toFixed(1);
            document.getElementById('effICE').value = (235.215 / curEffICE).toFixed(1);
            document.getElementById('distance').value = (curDist / 1.609).toFixed(0);
            document.getElementById('costFuel').value = (curFuelPrice * 3.785).toFixed(2);
        }
        calculate();
    });

    function updateLabels() {
        const u = CONFIG.metric ? 
            { dist: 'km', distShort: 'km', effEv: 'kWh/100km', effIce: 'L/100km', vol: 'L' } : 
            { dist: 'miles', distShort: 'mi', effEv: 'kWh/100mi', effIce: 'MPG', vol: 'gal' };
        
        document.querySelector('.unit-dist').textContent = u.dist;
        document.querySelectorAll('.unit-dist-short').forEach(e => e.textContent = u.distShort);
        document.querySelector('.unit-eff-ev').textContent = u.effEv;
        document.querySelector('.unit-eff-ice').textContent = u.effIce;
        document.querySelector('.unit-vol').textContent = u.vol;
    }

    /**
     * Core Calculation Logic
     */
    function getVal(id) { return parseFloat(document.getElementById(id).value) || 0; }
    function setVal(id, val) { document.getElementById(id).value = val; }

    function calculate() {
        // 1. Gather Inputs
        const years = getVal('years');
        const distance = getVal('distance');
        const discountRate = getVal('discountRate') / 100;
        const inflationRate = getVal('inflationRate') / 100;
        
        // CAPEX
        const evPrice = getVal('priceEV');
        const icePrice = getVal('priceICE');
        const evInitial = evPrice - getVal('incentiveEV') + getVal('chargerCost');
        const iceInitial = icePrice - getVal('incentiveICE');

        // Operating Inputs
        const evEff = getVal('effEV'); // kWh/100mi or kWh/100km
        const iceEff = getVal('effICE'); // MPG or L/100km
        const costElec = getVal('costElec');
        const costFuel = getVal('costFuel');
        
        const maintEV_Base = getVal('maintEV');
        const maintICE_Base = getVal('maintICE');
        const insurEV_Base = getVal('insurEV');
        const insurICE_Base = getVal('insurICE');

        // Resale
        const resaleEV_Pct = getVal('resalePctEV') / 100;
        const resaleICE_Pct = getVal('resalePctICE') / 100;

        // Emissions Inputs
        let gridIntensity = getVal('gridIntensity');
        if (document.getElementById('gridIntensity').value === 'custom') gridIntensity = getVal('gridCustom');
        const lifecycle = document.getElementById('lifecycleToggle').checked;

        // 2. Perform Yearly Simulations
        let dataEV = [];
        let dataICE = [];
        let cumlEV = evInitial;
        let cumlICE = iceInitial;
        
        let totalCO2_EV = lifecycle ? (EMISSIONS.ev_manufacturing_penalty_tons + EMISSIONS.ice_manufacturing_tons) * 1000 : EMISSIONS.ice_manufacturing_tons * 1000; // start with manufacturing
        let totalCO2_ICE = lifecycle ? EMISSIONS.ice_manufacturing_tons * 1000 : EMISSIONS.ice_manufacturing_tons * 1000;

        // Energy Calculations
        let energyCostEV, energyCostICE, annualCO2_EV, annualCO2_ICE;
        
        if (CONFIG.metric) {
            // Metric: Dist (km), Eff (kWh/100km), Eff (L/100km)
            const kwhPerYear = (distance / 100) * evEff;
            energyCostEV = kwhPerYear * costElec;
            annualCO2_EV = (kwhPerYear * gridIntensity) / 1000; // kg

            const litersPerYear = (distance / 100) * iceEff;
            energyCostICE = litersPerYear * costFuel;
            annualCO2_ICE = (litersPerYear * EMISSIONS.gasoline_g_per_liter) / 1000; // kg
        } else {
            // US: Dist (mi), Eff (kWh/100mi), Eff (MPG)
            const kwhPerYear = (distance / 100) * evEff;
            energyCostEV = kwhPerYear * costElec;
            annualCO2_EV = (kwhPerYear * gridIntensity) / 1000; // kg

            const gallonsPerYear = distance / iceEff;
            energyCostICE = gallonsPerYear * costFuel;
            annualCO2_ICE = (gallonsPerYear * EMISSIONS.gasoline_g_per_gal) / 1000; // kg
        }

        let paybackYear = null;
        let evCheaperOperatonal = (energyCostEV + maintEV_Base) < (energyCostICE + maintICE_Base);

        const tableBody = document.querySelector('#yearTable tbody');
        tableBody.innerHTML = '';

        // TCO Breakdown Buckets (Undiscounted for bar chart)
        let costBreakdown = {
            ev: { vehicle: evInitial, energy: 0, maint: 0, insur: 0, resale: 0 },
            ice: { vehicle: iceInitial, energy: 0, maint: 0, insur: 0, resale: 0 }
        };

        // NPV Totals
        let npvEV = evInitial;
        let npvICE = iceInitial;

        for (let y = 1; y <= years; y++) {
            // Inflation adjustments
            let inflationFactor = Math.pow(1 + inflationRate, y - 1);
            let discountFactor = Math.pow(1 + discountRate, y);

            // Annual Costs
            let yrEnergyEV = energyCostEV * inflationFactor;
            let yrEnergyICE = energyCostICE * inflationFactor;
            let yrMaintEV = maintEV_Base * inflationFactor;
            let yrMaintICE = maintICE_Base * inflationFactor;
            let yrInsurEV = insurEV_Base * inflationFactor;
            let yrInsurICE = insurICE_Base * inflationFactor;

            // Total Annual OpEx
            let opExEV = yrEnergyEV + yrMaintEV + yrInsurEV;
            let opExICE = yrEnergyICE + yrMaintICE + yrInsurICE;

            // Cumulative (Cash Outflow)
            cumlEV += opExEV;
            cumlICE += opExICE;

            // NPV Calculation
            npvEV += opExEV / discountFactor;
            npvICE += opExICE / discountFactor;

            // Add to breakdown
            costBreakdown.ev.energy += yrEnergyEV;
            costBreakdown.ev.maint += yrMaintEV;
            costBreakdown.ev.insur += yrInsurEV;
            costBreakdown.ice.energy += yrEnergyICE;
            costBreakdown.ice.maint += yrMaintICE;
            costBreakdown.ice.insur += yrInsurICE;

            // Emissions
            totalCO2_EV += annualCO2_EV;
            totalCO2_ICE += annualCO2_ICE;

            // Payback Check (Simple Payback on Cashflow)
            // If EV starts more expensive but line crosses ICE
            if (paybackYear === null && cumlEV < cumlICE && evInitial > iceInitial) {
                paybackYear = y - 1 + ((cumlICE - (opExICE) - (cumlEV - opExEV)) / ((cumlEV - (cumlEV-opExEV)) - (cumlICE - (cumlICE-opExICE))) ); 
                // Simplified interpolation, strictly speaking slightly off but good for visual approximation
                paybackYear = y; // Just using whole year for safety
            }

            // Store data for charts
            dataEV.push({ year: y, cost: cumlEV, annual: opExEV });
            dataICE.push({ year: y, cost: cumlICE, annual: opExICE });

            // Table Row
            let tr = `<tr>
                <td>${y}</td>
                <td>$${opExEV.toFixed(0)}</td>
                <td>$${cumlEV.toLocaleString()}</td>
                <td>$${opExICE.toFixed(0)}</td>
                <td>$${cumlICE.toLocaleString()}</td>
                <td style="color:${cumlICE - cumlEV > 0 ? 'var(--ev-color)' : 'var(--ice-color)'}">
                    $${(cumlICE - cumlEV).toLocaleString()}
                </td>
            </tr>`;
            tableBody.innerHTML += tr;
        }

        // Apply Resale at End (Present Value if discounted, else raw)
        // Note: For the TCO Number, we subtract Resale. For the Line chart, we show the drop at the end.
        let resaleValEV = evPrice * resaleEV_Pct;
        let resaleValICE = icePrice * resaleICE_Pct;

        // Add Resale point to chart data for the "Drop"
        dataEV.push({ year: years + 0.1, cost: cumlEV - resaleValEV });
        dataICE.push({ year: years + 0.1, cost: cumlICE - resaleValICE });

        // Final TCO Calculation
        let finalTCO_EV, finalTCO_ICE;
        
        if (discountRate > 0) {
            // Discount the resale value back to today
            let resalePV_EV = resaleValEV / Math.pow(1 + discountRate, years);
            let resalePV_ICE = resaleValICE / Math.pow(1 + discountRate, years);
            finalTCO_EV = npvEV - resalePV_EV;
            finalTCO_ICE = npvICE - resalePV_ICE;
        } else {
            finalTCO_EV = cumlEV - resaleValEV;
            finalTCO_ICE = cumlICE - resaleValICE;
        }

        costBreakdown.ev.resale = -resaleValEV;
        costBreakdown.ice.resale = -resaleValICE;

        // 3. Update UI Results
        document.getElementById('resTcoEV').innerText = fmtCurrency(finalTCO_EV);
        document.getElementById('resTcoICE').innerText = fmtCurrency(finalTCO_ICE);
        document.getElementById('cpmEV').innerText = fmtCurrency(finalTCO_EV / (distance * years));
        document.getElementById('cpmICE').innerText = fmtCurrency(finalTCO_ICE / (distance * years));

        const savings = finalTCO_ICE - finalTCO_EV;
        const resSavingsEl = document.getElementById('resSavings');
        resSavingsEl.innerText = fmtCurrency(Math.abs(savings));
        document.getElementById('cardSavings').querySelector('h3').innerText = savings > 0 ? "EV Savings" : "Gas Savings";
        resSavingsEl.style.color = savings > 0 ? "var(--ev-color)" : "var(--ice-color)";

        // Card Styling
        document.getElementById('cardEV').classList.remove('winner');
        document.getElementById('cardICE').classList.remove('winner');
        if (savings > 0) document.getElementById('cardEV').classList.add('winner');
        else document.getElementById('cardICE').classList.add('winner');

        // Payback Text
        const pbText = document.getElementById('paybackText');
        if (evInitial < iceInitial && evCheaperOperatonal) pbText.innerText = "EV Cheaper Upfront & to Operate";
        else if (savings > 0 && paybackYear) pbText.innerText = `Breakeven: Year ~${paybackYear}`;
        else if (savings > 0) pbText.innerText = "Breakeven within period";
        else pbText.innerText = "EV TCO is higher";

        // CO2 Text
        document.getElementById('co2EV').innerText = (totalCO2_EV / 1000).toFixed(1) + 't';
        document.getElementById('co2ICE').innerText = (totalCO2_ICE / 1000).toFixed(1) + 't';

        // 4. Render Charts
        renderLineChart(dataEV, dataICE, years);
        renderBarChart(costBreakdown);
        renderEmissionsChart(totalCO2_EV, totalCO2_ICE);
    }

    function fmtCurrency(num) {
        return CONFIG.currency + num.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    /**
     * SVG Chart Rendering Logic
     */
    function createSVG(width, height) {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(ns, "svg");
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.setAttribute("preserveAspectRatio", "none");
        return { svg, ns };
    }

    function renderLineChart(dataEV, dataICE, years) {
        const container = document.getElementById('lineChartContainer');
        container.innerHTML = '';
        const w = 800, h = 400;
        const pad = { top: 20, right: 20, bottom: 40, left: 60 };
        const { svg, ns } = createSVG(w, h);

        // Find scale
        const maxVal = Math.max(
            ...dataEV.map(d => d.cost), 
            ...dataICE.map(d => d.cost)
        ) * 1.1;

        const xScale = (year) => pad.left + (year / years) * (w - pad.left - pad.right);
        const yScale = (val) => h - pad.bottom - (val / maxVal) * (h - pad.top - pad.bottom);

        // Axes
        const xAxis = document.createElementNS(ns, "line");
        xAxis.setAttribute("x1", pad.left); xAxis.setAttribute("y1", h - pad.bottom);
        xAxis.setAttribute("x2", w - pad.right); xAxis.setAttribute("y2", h - pad.bottom);
        xAxis.setAttribute("stroke", "#cbd5e1");
        svg.appendChild(xAxis);

        const yAxis = document.createElementNS(ns, "line");
        yAxis.setAttribute("x1", pad.left); yAxis.setAttribute("y1", pad.top);
        yAxis.setAttribute("x2", pad.left); yAxis.setAttribute("y2", h - pad.bottom);
        yAxis.setAttribute("stroke", "#cbd5e1");
        svg.appendChild(yAxis);

        // Labels
        for(let i=0; i<=years; i+= Math.ceil(years/5)) {
            const txt = document.createElementNS(ns, "text");
            txt.setAttribute("x", xScale(i));
            txt.setAttribute("y", h - 10);
            txt.setAttribute("text-anchor", "middle");
            txt.setAttribute("fill", "#64748b");
            txt.setAttribute("font-size", "14");
            txt.textContent = "Yr " + i;
            svg.appendChild(txt);
        }

        // Draw Path Function
        function drawPath(data, color, dash = "") {
            let d = `M ${pad.left} ${yScale(data[0].cost - data[0].annual)} `; // Start at Y0 cost (Initial)
            // Need accurate Y0. data[0] is year 1. 
            // Better logic: Inputs has Initial Cost.
            // Let's rely on data array which should have been prepended with year 0. 
            // I'll fix the loop logic visually by just connecting points in data array.
            
            // Reconstruct points: Start at Year 0 (Initial Cost)
            // dataEV doesn't have Y0. 
            // Hack: First point x=0, y=Initial.
            // But data[0].cost is Cumulative Year 1.
            const initial = data[0].cost - data[0].annual;
            d = `M ${xScale(0)} ${yScale(initial)} `;

            data.forEach(p => {
                // If it's the resale drop (fractional year), maintain vertical line
                d += `L ${xScale(p.year > years ? years : p.year)} ${yScale(p.cost)} `;
            });
            
            const path = document.createElementNS(ns, "path");
            path.setAttribute("d", d);
            path.setAttribute("stroke", color);
            path.setAttribute("stroke-width", "3");
            path.setAttribute("fill", "none");
            if(dash) path.setAttribute("stroke-dasharray", dash);
            svg.appendChild(path);

            // Add circle at end
            const last = data[data.length-1];
            const circ = document.createElementNS(ns, "circle");
            circ.setAttribute("cx", xScale(years));
            circ.setAttribute("cy", yScale(last.cost));
            circ.setAttribute("r", "5");
            circ.setAttribute("fill", color);
            svg.appendChild(circ);
        }

        drawPath(dataEV, getComputedStyle(document.documentElement).getPropertyValue('--ev-color').trim());
        drawPath(dataICE, getComputedStyle(document.documentElement).getPropertyValue('--ice-color').trim());
        
        container.appendChild(svg);
    }

    function renderBarChart(bd) {
        const container = document.getElementById('barChartContainer');
        container.innerHTML = '';
        const w = 400, h = 300;
        const { svg, ns } = createSVG(w, h);
        
        // Data prep: Positive costs only for stacking
        // Resale is negative, visualize it as a dip or just Net Total bar?
        // Let's do breakdown of SPEND (Vehicle, Energy, Maint) then show Resale as a block below zero.
        
        const pad = { left: 50, top: 20, bottom: 40 };
        const barW = 60;
        
        // Calculate Totals for scale
        const totalEV = bd.ev.vehicle + bd.ev.energy + bd.ev.maint + bd.ev.insur;
        const totalICE = bd.ice.vehicle + bd.ice.energy + bd.ice.maint + bd.ice.insur;
        const maxVal = Math.max(totalEV, totalICE) * 1.2;
        
        const yScale = (v) => (v / maxVal) * (h - pad.top - pad.bottom);
        const yPos = (v) => (h - pad.bottom) - yScale(v);

        function drawStack(x, data, colorBase) {
            let currentY = h - pad.bottom;
            
            const categories = [
                { key: 'vehicle', color: colorBase, label: 'Vehicle' },
                { key: 'energy', color: '#fcd34d', label: 'Fuel/Energy' }, // yellow
                { key: 'maint', color: '#a78bfa', label: 'Maint' }, // purple
                { key: 'insur', color: '#fb7185', label: 'Insur' } // pink
            ];
            // Override specific colors for ICE to distinguish
            const colors = {
                ev: ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0'],
                ice: ['#ea580c', '#fdba74', '#fed7aa', '#ffedd5']
            };
            
            let cIdx = colorBase === 'ev' ? 0 : 1;
            let palette = colorBase === 'ev' ? colors.ev : colors.ice;

            // Draw Positive Stacks
            ['vehicle', 'energy', 'maint', 'insur'].forEach((key, i) => {
                const val = data[key];
                const hBar = yScale(val);
                currentY -= hBar;
                
                const rect = document.createElementNS(ns, "rect");
                rect.setAttribute("x", x);
                rect.setAttribute("y", currentY);
                rect.setAttribute("width", barW);
                rect.setAttribute("height", hBar);
                rect.setAttribute("fill", palette[i]);
                rect.setAttribute("stroke", "#fff");
                
                // Simple Tooltip logic
                rect.addEventListener('mouseenter', (e) => showTooltip(e, `${key}: $${Math.round(val)}`));
                rect.addEventListener('mousemove', moveTooltip);
                rect.addEventListener('mouseleave', hideTooltip);
                
                svg.appendChild(rect);
            });

            // Draw Resale (Below line)
            if(data.resale) {
                const rH = yScale(Math.abs(data.resale));
                const rRect = document.createElementNS(ns, "rect");
                rRect.setAttribute("x", x);
                rRect.setAttribute("y", h - pad.bottom);
                rRect.setAttribute("width", barW);
                rRect.setAttribute("height", rH);
                rRect.setAttribute("fill", "#94a3b8"); // grey for resale
                rRect.setAttribute("opacity", "0.7");
                 rRect.addEventListener('mouseenter', (e) => showTooltip(e, `Resale Credit: $${Math.round(Math.abs(data.resale))}`));
                rRect.addEventListener('mousemove', moveTooltip);
                rRect.addEventListener('mouseleave', hideTooltip);
                svg.appendChild(rRect);
            }
        }

        drawStack(100, bd.ev, 'ev');
        drawStack(240, bd.ice, 'ice');

        // Axis
        const line = document.createElementNS(ns, "line");
        line.setAttribute("x1", 0); line.setAttribute("y1", h - pad.bottom);
        line.setAttribute("x2", w); line.setAttribute("y2", h - pad.bottom);
        line.setAttribute("stroke", "#333");
        svg.appendChild(line);

        // Labels
        const lblEV = document.createElementNS(ns, "text");
        lblEV.setAttribute("x", 100 + barW/2); lblEV.setAttribute("y", h - 10);
        lblEV.setAttribute("text-anchor", "middle"); lblEV.textContent = "EV";
        svg.appendChild(lblEV);
        
        const lblICE = document.createElementNS(ns, "text");
        lblICE.setAttribute("x", 240 + barW/2); lblICE.setAttribute("y", h - 10);
        lblICE.setAttribute("text-anchor", "middle"); lblICE.textContent = "Gas";
        svg.appendChild(lblICE);

        container.appendChild(svg);
    }

    function renderEmissionsChart(evCO2, iceCO2) {
        const container = document.getElementById('emissionsChartContainer');
        container.innerHTML = '';
        const w = 400, h = 150;
        const { svg, ns } = createSVG(w, h);

        const max = Math.max(evCO2, iceCO2) * 1.2;
        const barH = 40;
        
        // EV Bar
        const wEV = (evCO2 / max) * 300;
        const rEV = document.createElementNS(ns, "rect");
        rEV.setAttribute("x", 50); rEV.setAttribute("y", 20);
        rEV.setAttribute("height", barH); rEV.setAttribute("width", wEV);
        rEV.setAttribute("fill", "var(--ev-color)");
        rEV.setAttribute("rx", "4");
        svg.appendChild(rEV);
        
        // ICE Bar
        const wICE = (iceCO2 / max) * 300;
        const rICE = document.createElementNS(ns, "rect");
        rICE.setAttribute("x", 50); rICE.setAttribute("y", 80);
        rICE.setAttribute("height", barH); rICE.setAttribute("width", wICE);
        rICE.setAttribute("fill", "var(--ice-color)");
        rICE.setAttribute("rx", "4");
        svg.appendChild(rICE);

        // Labels
        const tEV = document.createElementNS(ns, "text");
        tEV.setAttribute("x", 10); tEV.setAttribute("y", 45);
        tEV.setAttribute("font-weight", "bold");
        tEV.textContent = "EV";
        svg.appendChild(tEV);

        const tICE = document.createElementNS(ns, "text");
        tICE.setAttribute("x", 10); tICE.setAttribute("y", 105);
        tICE.setAttribute("font-weight", "bold");
        tICE.textContent = "Gas";
        svg.appendChild(tICE);

        container.appendChild(svg);
    }

    // Tooltip Helper
    const tooltip = document.getElementById('tooltip');
    function showTooltip(e, text) {
        tooltip.textContent = text;
        tooltip.style.opacity = 1;
        moveTooltip(e);
    }
    function moveTooltip(e) {
        const rect = e.target.getBoundingClientRect(); // relative to viewport
        // Simple positioning
        tooltip.style.left = e.pageX + 10 + 'px';
        tooltip.style.top = e.pageY - 20 + 'px';
    }
    function hideTooltip() {
        tooltip.style.opacity = 0;
    }

    // Initialize
    updateLabels();
    calculate();

</script>
</body>

</html>
